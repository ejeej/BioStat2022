---
title: "Доказательная медицина, ДЗ №1"
author: "Мироненко Ольга"
output:
  pdf_document:
    latex_engine: xelatex
header-includes:
- \usepackage{polyglossia}
- \setdefaultlanguage{russian}
- \newfontfamily{\cyrillicfont}{Times New Roman} 
- \newfontfamily{\cyrillicfontrm}{Times New Roman}
- \newfontfamily{\cyrillicfonttt}{Courier New}
- \newfontfamily{\cyrillicfontsf}{Arial}
fontsize: 12pt
geometry: margin=2cm
papersize: a4
urlcolor: blue
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(labelled)
library(gtsummary)
library(ggsurvfit)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)
options(scipen = 999, encoding = "UTF-8")
```

## **Задание 1**

<br>

Таблица сопряженности:

```{r, results='asis'}
df <- read.csv("hypertension.csv", encoding = "UTF-8")
names(df) <- c("id", "male", "hyp")

df <- df %>%
  mutate(male = factor(male, 1:0, c("Мужчины", "Женщины")),
         hyp = factor(hyp, 1:0, c("Гипертония", "Нет гипертонии")))

tbl_summary(df %>% select(-id), by = "hyp", 
            statistic = all_categorical() ~ "{n}", label = male ~ "") %>%
  modify_header(all_stat_cols() ~ "**{level} (N = {n})**",
                label = "") %>%
  add_overall(last = TRUE, col_label = "**Всего (N = {N})**") %>%
  modify_footnote(everything() ~ NA)
```

Риск заболеваемости гипертонией:

- для мужчин: $R_{male} = 7/51$ = `r round(7/51,2)`

- для женщин: $R_{female} = 3/49$ = `r round(3/49,2)`

Для их сравнения рассчитаем отношение рисков ($RR$) и абсолютную разницу в рисках ($RD$):

- $RR = R_{male} / R_{female} = (7/51)/(3/49)$ = `r round(7/51/3*49,1)`, т.е. для мужчин риск (частота встречаемости) гипертонии в `r round(7/51/3*49,1)` раза выше, чем для женщин.

- $RD = R_{male} - R_{female} = (7/51) - (3/49)$ = `r round(7/51 - 3/49,2)`, т.е. для мужчин риск (частота встречаемости) гипертонии на `r round(7/51 - 3/49,2)` (или на `r round((7/51 - 3/49)*100,0)` процентных пунктов) выше, чем для женщин.

Интерпретация будет зависеть от того, насколько клинически значимым является значение $RD$ (это должны определять клиницисты) - от этого будет зависеть, насколько больше следует делать акцент в профилактических мероприятиях (если они возможны в данном случае) на пациентов мужского пола по сравнению с женским. Что касается возможных причин такой разницы, то, вероятнее всего, она связана с некоторыми факторами, ассоциированными с полом, - это уже вопрос для дополнительных исследований.

<br>

\newpage

## **Задание 2**

<br>

Таблица сопряженности:

```{r}
df <- read.csv("otravlenie.csv", encoding = "UTF-8")
names(df) <- c("id", "meat", "fish", "salad", "otr")

df <- df %>%
  mutate_at(vars(meat:salad), ~ factor(., 1:0, c("Да", "Нет"))) %>%
  mutate(otr = factor(otr, 1:0, c("Отравление", "Нет отравления")))

var_label(df) <- list(meat = "Мясо", fish = "Рыба", salad = "Салат")

tbl_summary(df %>% select(-id), by = "otr",
            statistic = all_categorical() ~ "{n}") %>%
  modify_header(all_stat_cols() ~ "**{level} (N = {n})**",
                label = "") %>%
  # add_overall(last = TRUE, col_label = "**Всего**<br>N = {N}") %>%
  modify_footnote(everything() ~ NA) %>%
  bold_labels()

df <- df %>%
  rowwise() %>%
  mutate(menu = pmap_chr(list(meat, fish, salad), 
                         function(x,y,z) {
                           dishes <- as.numeric(c(x,y,z))
                           dishes <- c("M", "F", "S")[dishes == 1]
                           paste(dishes, collapse = " + ")
                         })) %>% 
  ungroup() %>%
  mutate(menu = fct_infreq(ifelse(menu == "", "N", menu)),
         menu2 = factor(ifelse(meat == "Да" | salad == "Да", 1, 0), 1:0, c("M or S", "No M and no S")))
```

В данном случае мы имеем дело с результатами исследования случай-контроль (предполагаем, что опрашивали не всех обедавших в столовой студентов, не имевших симптомов отравления), поэтому, без знаний о baseline риске, мы не можем оценить ни риск отравления в случае употребления/ неупотребления каждого блюда, ни отношение этих рисков - подходящей мерой ассоциации между съеденным блюдом и отравлением является отношение шансов ($OR$) отравления для тех, кто его ел, по сравнению с теми, кто нет:

- Мясо: $OR = Odds_{\text{meat}}/Odds_{\text{no meat}} = (16/39)/(4/41)$ = `r round((16/39)/(4/41),1)`

- Рыба: $OR = Odds_{\text{fish}}/Odds_{\text{no fish}} = (3/42)/(17/38)$ = `r round((3/42)/(17/38),1)`

- Салат: $OR = Odds_{\text{salad}}/Odds_{\text{no salad}} = (14/59)/(6/21)$ = `r round((14/59)/(6/21),1)`

Получается, что шанс отравиться был заметно выше для тех, кто ел мясо ($OR > 1$), по сравнению с теми, кто его не ел. Евшие салат и не евшие салат имели близкий шанс отравиться ($OR$ относительно близко к 1). А употребление рыбы как будто бы и вовсе уберегало от отравления :) ($OR$ близко к 0).

_Что касается "защитных свойств рыбы", то первой мыслью при выполнении задания было, что те, кто ел рыбу, видимо, реже ели мясо, и это их уберегло )) Но я посмотрела на долю евших и не евших мясо среди евших рыбу - там практически поровну, что несильно отличается от картины среди евших салат и среди всех опрошенных (и там, и там чуть больше половины ели мясо). Иными словами, были сомнения, что выбор мяса был как-то связан с выбором рыбы или салата. И дальше я эту мысль раскручивать не стала. Теперь попробую._

Можно отметить следующее:

- Если бы мы имели дело с результатами когортного исследования, то я бы предположила, что такой результат может объясняться, в частности, тем, что рыбу ели реже мяса и салата (т.е. prevalence рыбы был маленький), но тут мы оцениваем отношения шансов, которые от prevalence не зависят, и оценить отношение рисков не можем.

- Вообще говоря, мы не можем сравнивать подсчитанные выше отношения шансов между проверяемыми тремя блюдами, поскольку многие посетители столовой съели за обедом несколько блюд одновременно. В такой ситуации, если виновным оказалось какое-то одно блюдо, но оно часто приобреталось в паре с каким-либо другим, то мы увидим высокие шансы отравления для них обоих, несмотря на "невиновность" второго. Напротив, если блюдо редко покупалось в паре с непригодным, то шансы отравиться таким блюдом будут низкими и соответствующее отношение шансов будет близко к 0, хотя, конечно, это вовсе не будет свидетельствовать о его способности защитить от отравления :)

- В подобной ситуации мы можем для каждого опрошенного определить, каким было его меню на том обеде - это уже будут альтернативные друг другу варианты "воздействия", объекты которых не будут пересекаться. Ниже приведу таблицу сопряженности для этого меню и полученные шансы отравления (M - мясо, F - рыба, S - салат, N - ни того, ни другого, не третьего), отсортировав варианты меню по убыванию этих шансов:

```{r}
tbl <- table(df$menu, df$otr)
tbl <- data.frame(menu = rownames(tbl), otr = tbl[,1], nootr = tbl[,2], row.names = NULL)
tbl <- tbl %>% mutate(odds = round(otr/nootr,2)) %>% arrange(-odds)
knitr::kable(tbl, col.names = c("Меню", "Отравление", "Нет отравления", "Шанс отравления"), 
             align = "lccc") %>%
  kableExtra::kable_styling(full_width = FALSE)
```

Получается, что нулевые шансы отравиться были только у тех, кто ел только рыбу, мясо с рыбой или не ел ни одно из трёх проверяемых блюд. Иными словами, все отравившиеся ели либо мясо, либо салат, либо и то, и другое - и либо дополняли их рыбой, либо нет, но рыба, по всей видимости, точно была невиновна в их отравлении. К подозрительному мясу добавляется подозрительный салат :) Можно даже сгруппировать все меню в 2 варианта:

```{r}
tbl <- table(df$menu2, df$otr)
tbl <- data.frame(menu2 = rownames(tbl), otr = tbl[,1], nootr = tbl[,2], row.names = NULL)
tbl <- tbl %>% mutate(odds = round(otr/nootr, 2)) %>% arrange(-odds)
knitr::kable(tbl, col.names = c("Меню", "Отравление", "Нет отравления", "Шанс отравления"), align = "lccc") %>%
  kableExtra::kable_styling(full_width = FALSE)
```

Соответственно, отношение шансов отравления при употреблении мяса или салата к шансам отравления при отказе от того и другого стремится к бесконечности. А рыба, видимо, была годная, хотя и не волшебная и, возможно, не пользовавшаяся особым спросом :) Что касается 5 человек, которым в обеде, состоявшем из мяса и рыбы, удалось избежать отравления, то это, на мой взгляд, вполне укладывается в общую картину того, что отравились всё-таки не все, кто ел в тот день мясо или салат.

<br>

## **Задание 3**

<br>

```{r, message=FALSE}
df <- read.csv("carrental.csv", encoding = "UTF-8")
names(df) <- c("id", "exp", "start", "stop", "acc")

df <- df %>%
  mutate(time = stop - start)

n_e <- sum(df$exp == 1 & df$acc == 1)
N_e <- sum(df$exp == 1)
ip_e <- n_e/N_e
tr_e <- sum(df$time[df$exp == 1])
ir_e <- n_e/tr_e
at_e <- mean(df$time[df$exp == 1])
mt_e <- median(df$time[df$exp == 1])
mt_a_e <- median(df$time[df$exp == 1 & df$acc == 1])
mt_na_e <- median(df$time[df$exp == 1 & df$acc == 0])

n_ne <- sum(df$exp == 0 & df$acc == 1)
N_ne <- sum(df$exp == 0)
ip_ne <- n_ne/N_ne
tr_ne <- sum(df$time[df$exp == 0])
ir_ne <- n_ne/tr_ne
at_ne <- mean(df$time[df$exp == 0])
mt_ne <- median(df$time[df$exp == 0])
mt_a_ne <- median(df$time[df$exp == 0 & df$acc == 1])
mt_na_e <- median(df$time[df$exp == 0 & df$acc == 0])

```

Страховая компания хочет сравнить случаемость (incidence) ДТП между случаями аренды машин опытными и неопытными водителями в течение отчётного года. Судя по данным, мы имеем дело с продольным исследованием: водители брали в аренду машину в разное время в течение года (от `r min(df$start)`-го до `r max(df$start)`-го дней года), кто-то закончил аренду до окончания года (`r sum(df$stop[df$acc == 0] < 365)` - не по причине ДТП, `r sum(df$stop[df$acc == 1] < 365)` - по причине ДТП), оставшиеся (`r sum(df$stop[df$acc == 0] == 365)` чел.) являлись активными клиентами компании на последний день года. Из 100 клиентов `r sum(df$exp == 1)` имели опыт вождения до аренды автомобиля, `r sum(df$exp == 0)` - нет.

Для подобного исследования мы можем рассчитать следующие показатели случаемости ДТП:

- **Incidence proportion (risk, IP)** - доля клиентов компании, у которых было ДТП в течение года (n - кол-во случаев ДТП, N - кол-во клиентов):

    - Среди водителей, имевших опыт вождения: $IP_{exp} = n_{exp}/N_{exp}*100\%$ = `r n_e`/`r N_e`*100% = `r round(ip_e*100,1)`%.
    
    - Среди водителей, не имевших опыта вождения: $IP_{no exp} = n_{no exp}/N_{no exp}*100\%$ = `r n_ne`/`r N_ne`*100% = `r round(ip_ne*100,1)`%.
    
    - Чтобы их сравнить, можем рассчитать отношение рисков: $RR = IP_{exp}/IP_{no exp}$ = `r round(ip_e*100,1)`/`r round(ip_ne*100,1)` = `r round(ip_e/ip_ne,2)` - получается, что риск ДТП для опытных водителей в 1/`r round(ip_e/ip_ne,2)` = `r round(1/ip_e*ip_ne,1)` раза меньше, чем для неопытных.
    
    - Также можем оценить асболютную разницу рисков: $RD = IP_{exp}-IP_{no exp}$ = `r round(ip_e,3)`/`r round(ip_ne,3)` = `r round(ip_e-ip_ne,3)`, т.е. риск ДТП среди опытных водителей на `r -round((ip_e-ip_ne)*100,1)` процентных пункта ниже, чем среди неопытных.
    
Но я бы не стала ориентироваться на эти результаты и основывать на них выводы о необходимости предоставления скидки опытным водителям, поскольку incidence risk никак не учитывает различий в длительности контрактов с водителями, а она, по всей видимости, различается между опытными и неопытными водителями: так, медиана продолжительности контракта с первыми составила `r mt_e` дня, со вторыми - `r mt_ne`, т.е. большая частота ДТП, зафиксированных среди неопытных водителей, могла быть связана с большей продолжительностью контрактов с ними. Поэтому я бы исходила из показателей ниже, которые эту разницу учитывают.
    
- **Incidence rate (IR)** - "скорость" прекращения контракта (аренды) в связи с ДТП (n - кол-во случаев ДТП, TR - суммарное время at risk по всем клиентам, где для каждого клиента время at risk рассчитывалось как разница между stop и start временем):

    - Среди водителей, имевших опыт вождения: $IR_{exp} = n_{exp}/TR_{exp}$ = `r n_e`/`r tr_e` = `r round(ir_e,3)` случаев ДТП/ клиенто-дней.
    
    - Среди водителей, не имевших опыта вождения: $IR_{no exp} = n_{no exp}/TR_{no exp}$ = `r n_ne`/`r tr_ne` = `r round(ir_ne,3)` случаев ДТП/ клиенто-дней.
    
    - Incidence rate получился одинаковым в обеих группах клиентов, т.е. скорость прекращения аренды в связи с ДТП не связана с предшествующим стажем вождения.

- **Cumulative incidence (CI)** - кумулятивная вероятность ДТП, оцененная для различных сроков аренды - отразим её на графике ниже в виде кривых, дополнительных к кривым Каплана-Мейера:

```{r, message=FALSE, fig.width=3.5, fig.height=2.5}
df <- df %>%
  mutate(exp = factor(exp, 1:0, c("Exp", "No exp")))

sfit <- survfit(Surv(time, acc) ~ exp, df)
sfit_s <- summary(sfit, times = c(1,2,3)/12*365)

survfit2(Surv(time, acc) ~ exp, df) %>%
  ggsurvfit(size = 1.5, type = "risk") +
  labs(x = "Rent duration, months",
       y = "Cumulative incidence\nof accidents") +
  scale_y_continuous(breaks = seq(0,1,0.1),
                     limits = c(0,1),
                     expand = c(0,0)) +
  scale_x_continuous(breaks = seq(0,365,365/12),
                     labels = seq(0,12,1),
                     limits = c(0, 365),
                     expand = c(0,0)) +
  scale_color_manual(values = c("#4E79A7", "#E15759")) +
  theme_classic() +
  theme(legend.position = c(0.8,0.8))
```

Видим, что длительность аренды машин опытными водителями заметно ниже, и фактически мы можем сравнивать кумулятивные вероятности ДТП между группами только до срока примерно 3,5 мес. - можно сказать, что в рамках этих сроков кумулятивные вероятности ДТП практически не отличаются, т.е. не зависят от предшествующего опыта вождения.
    
Таким образом, **ориентируясь на incidence rate и cumulative incidence, я бы утверждала, что случаемость ДТП не зависит от наличия стажа вождения, и скидку бы опытным водителям не давала**.
